(function(c,b){c.soco=c.soco||{};
c.soco.commons=c.soco.commons||{};
c.soco.TEMPLATE_PARAMNAME=":templatename";
c.soco.filterHTMLFragment=c.soco.filterHTMLFragment||function(d,f){try{f.call(null,b(d))
}catch(g){throw g
}};
var a={};
a.CLEAR="lcl.cq.soco.events.clear";
c.soco.commons.handleOnBlur=function(d,e){if((b(d).val()==="")||(b(d).val()==="<br/>")){b(d).val(e)
}};
c.soco.commons.handleOnFocus=function(d,e){if(b(d).val()===e){b(d).val("")
}};
c.soco.commons.getMessage=function(d){var f=b(d).first().val();
if(typeof CKEDITOR!=="undefined"){var e=CKEDITOR.instances[b(d).attr("id")];
if(e){f=e.getData()
}}return f
};
c.soco.commons.validateFieldNotEmptyOrDefaultMessage=function(f,e){c.soco.commons.syncRTE(f);
var d=b(f).val();
if(!e){e=""
}var g="tempRTEValidate_"+Math.floor(Math.random()*1001);
b(f).after("<div id='"+g+"' height='0px' style='visibility:hidden;' width='0px'></div>");
d=c.soco.commons.stripNonText(d);
e=c.soco.commons.stripNonText(e);
b("#"+g).append(d);
b("#"+g+" div:empty").filter(function(){return b(this)
}).remove();
b("#"+g+" p:empty").filter(function(){return b(this)
}).remove();
d=b("#"+g).html();
b("#"+g).remove();
if(b.trim(d).length===0||b.trim(d)===e){alert(c.I18n.getMessage("Comment field cannot be empty or default message."));
return false
}else{return true
}};
c.soco.commons.stripNonText=function(d){d=d.replace(/\s|&nbsp;/g,"");
d=d.replace(/\r?\n|\r/g,"");
d=d.replace(/(<|&lt;)br\s*\/*(>|&gt;)/g,"");
return d
};
c.soco.commons.syncRTE=function(d){if(typeof CKEDITOR!=="undefined"){var e=CKEDITOR.instances[b(d).attr("name")];
if(!e){e=CKEDITOR.instances[b(d).attr("id")]
}if(e&&e.checkDirty()){e.updateElement();
e.resetDirty()
}}};
c.soco.commons.clientSideComposer=function(i,k,j,e,h,g,f){var l=g||i.attr("action"),d=f||i.attr("method")||"POST";
i.find(":submit").click(function(s){var o=$.map(i.find(":input[type='file']"),function(v){var u=$(v);
if(u.val()===""||u.val()===undefined){return null
}return true
}).length>0;
if(o){return
}s.preventDefault();
var r=b(s.target).closest("form")[0],t;
if(b.isFunction(r.onsubmit)){if(!r.onsubmit.call(r,s)){return
}}var q=i.find("textarea");
c.soco.commons.syncRTE(q);
t=b(r).serialize();
if(k){t+="&"+encodeURIComponent(c.soco.TEMPLATE_PARAMNAME)+"="+encodeURIComponent(k)
}for(var p in h){t+="&"+encodeURIComponent(p)+"="+encodeURIComponent(h[p])
}b(r).find(":input:visible").each(function(){b(this).attr("disabled","disabled")
});
var n=function(v,u,w){if((w.status===201)||(w.status===200)){b(r).find(":input:visible").each(function(){switch(this.type){case"password":case"select-multiple":case"select-one":case"text":case"textarea":b(this).val("");
break;
case"checkbox":case"radio":this.checked=false
}b(this).removeAttr("disabled")
});
b(r).find(":input:hidden").each(function(){b(this).trigger(a.CLEAR)
});
j.call(null,v,u,w)
}else{b(r).find(":input:visible").each(function(){b(this).removeAttr("disabled")
});
e.call(null,w,u)
}};
var m=function(v,u){b(r).find(":input:visible").each(function(){b(this).removeAttr("disabled")
});
e.call(null,v,u)
};
b.ajax(l,{data:t,success:n,fail:m,type:d})
})
};
c.soco.commons.fillInputFromClientContext=function(d,e){if(window.CQ_Analytics&&CQ_Analytics.CCM){b(function(){var f=CQ_Analytics.CCM.getRegisteredStore(CQ_Analytics.ProfileDataMgr.STORENAME);
if(f){var g=f.getProperty(e,true)||"";
d.val(g)
}CQ_Analytics.CCM.addListener("storesloaded",function(){var h=CQ_Analytics.CCM.getRegisteredStore(CQ_Analytics.ProfileDataMgr.STORENAME);
if(h&&h.addListener){var i=h.getProperty(e,true)||"";
d.val(i);
h.addListener("update",function(){var j=h.getProperty(e,true)||"";
d.val(j)
})
}})
})
}};
c.soco.commons.activateRTE=function(f,d){var e=f.find("textarea");
c.soco.commons.convertTextAreaToRTE(e,d,true)
};
c.soco.commons.convertTextAreaToRTE=function(d,g,j){var e=d.width(),q=d.height(),p=[{name:"basicstyles",items:["Bold","Italic","Underline"]}],n={},m=d[0],o,k;
var h=g||["onfocus","onblur"];
if(m!==null&&typeof m!=="undefined"){for(k=0;
k<h.length;
k++){o=h[k];
if(null!==m[o]){n[o.substring(2)]=m[o]
}}}o=null;
b(d).height(d.height()+60);
var f={width:e,height:q,toolbar:p};
if(!j){f.width=d.width()===0?"100%":e;
f.height=d.height()===0?"100%":q;
f.toolbarLocation="bottom";
f.resize_enabled=false;
f.removePlugins="elementspath"
}else{f.width=e+4;
f.height=q+60
}var l=CKEDITOR.replace(b(d).attr("name"),f);
l.on("key",function(i){c.soco.commons.syncRTE(d)
});
d.on(a.CLEAR,function(i){b(m).val("");
l.setData("",function(){b(l).blur();
l.resetDirty()
})
});
return l
};
c.soco.commons.openModeration=function(){var d="";
if(c.WCM!==undefined&&c.WCM.getPagePath!==undefined){d=c.WCM.getPagePath()
}else{if(Granite.author!==undefined&&Granite.author.page!==undefined&&Granite.author.page.path!==undefined){d=Granite.author.page.path
}}c.shared.Util.open(c.shared.HTTP.externalize("/communities/moderation.html"))
};
c.soco.commons.showUGCFormAsDialog=function(h,f){var g=b(f);
var d=g.attr("id");
var e="modalIframeParent"+Math.random().toString(36).substring(2,4);
if(!d){g.attr("id",e);
d=e
}g.dialog({modal:true,height:500,width:750,buttons:{Submit:function(){var i=b("iframe.modalIframeClass",g).contents().find("form");
i.submit();
b(this).dialog("close")
},Cancel:function(){b(this).dialog("close")
}}});
g.html("<iframe class='modalIframeClass' width='100%' height='100%' marginWidth='0' marginHeight='0' frameBorder='0' />").dialog("open");
b("#"+d+" .modalIframeClass").attr("src",h);
return false
}
})(CQ,$CQ);
var CQ_collab_comments_loadedForms={};
var CQ_collab_comments_defaultMessage="";
var CQ_collab_comments_requireLogin=false;
var CQ_collab_comments_enterComment="Please enter a comment";
function CQ_collab_comments_toggleForm(c,h,a){var d=document.getElementById(h);
var b=document.getElementById(c);
try{a=CQ.shared.HTTP.noCaching(a);
CQ.shared.HTTP.get(a,function(p,k,j){var e=j.responseText;
$CQ(d).html(e);
var n=$CQ(d).children("form").attr("id");
if(n){var m=n.split("-");
m.length=m.length-1;
var l=m.join("-");
if(CQ_Analytics&&CQ_Analytics.CCM){var i=CQ_Analytics.CCM.getRegisteredStore(CQ_Analytics.ProfileDataMgr.STORENAME);
if(i){CQ_collab_comments_formStateChanged(l,i)
}}}})
}catch(g){alert("Error loading form: "+a)
}var f=d.style.display!="block";
d.style.display=f?"block":"none";
b.innerHTML=f?"Cancel":"Reply"
}function CQ_collab_comments_handleOnFocus(a,b){if(a.value==CQ_collab_comments_getDefaultMessage(b)){a.value=""
}a.style.color="#333"
}function CQ_collab_comments_handleOnBlur(a,b){if(a.value===""){a.value=CQ_collab_comments_getDefaultMessage(b);
a.style.color="#888"
}else{a.style.color="#333"
}}function CQ_collab_comments_validateFields(b){var a=document.getElementById(b+"-text");
if(a.value===""||a.value===CQ_collab_comments_getDefaultMessage(b)){CQ_collab_comments_showError(CQ_collab_comments_enterComment,b);
return false
}return true
}function CQ_collab_comments_validateSubmit(d){if(!CQ_collab_comments_validateFields(d)){return false
}try{var a=document.getElementById(d+"-id");
if(!a){var b=document.getElementById(d+"-form");
a=document.createElement("input");
a.id=d+"-id";
a.type="hidden";
a.name="id";
a.value="nobot";
b.appendChild(a)
}}catch(c){return false
}return true
}function CQ_collab_comments_showError(b,c){var a=document.getElementById(c+"-error");
if(!a){alert(b)
}else{a.innerHTML=b
}}function CQ_collab_comments_getDefaultMessage(a){if(a&&document.getElementById(a+"-rating")){return CQ_collab_ratings_defaultMessage
}return CQ_collab_comments_defaultMessage
}function CQ_collab_comments_openCollabAdmin(){CQ.shared.Util.open(CQ.shared.HTTP.externalize("/socoadmin.html#/content/usergenerated"+CQ.WCM.getPagePath()))
}function CQ_collab_comments_activate(a,b){if(!a){a="Activate"
}CQ.HTTP.post("/bin/replicate.json",function(d,e,c){if(a==="Delete"){CQ.Notification.notify(null,e?CQ.I18n.getMessage("Comment deleted"):CQ.I18n.getMessage("Unable to delete comment"))
}else{CQ.Notification.notify(null,e?CQ.I18n.getMessage("Comment activated"):CQ.I18n.getMessage("Unable to activate comment"))
}if(b){b.call(this,d,e,c)
}},{_charset_:"utf-8",path:this.path,cmd:a})
}function CQ_collab_comments_refresh(){if(this.refreshCommentSystem){this.refreshCommentSystem()
}else{CQ.wcm.EditBase.refreshPage()
}}function CQ_collab_comments_afterEdit(a){CQ_collab_comments_activate.call(a,"Activate",CQ_collab_comments_refresh)
}function CQ_collab_comments_afterDelete(a){CQ_collab_comments_activate.call(a,"Delete",CQ_collab_comments_refresh)
}function CQ_collab_comments_initFormState(a){if(CQ_Analytics&&CQ_Analytics.CCM){$CQ(function(){CQ_Analytics.ClientContextUtils.onStoreRegistered(CQ_Analytics.ProfileDataMgr.STORENAME,function(b){CQ_collab_comments_formStateChanged(a,b);
b.addListener("update",function(){CQ_collab_comments_formStateChanged(a,b)
})
})
})
}}function CQ_collab_comments_formStateChanged(a,g){var c=g.getData();
if(c){var h=a+"-form";
var j=a+"-text";
var b=a+"-userIdentifier";
var e=a+"-email";
var i=a+"-url";
var f=c.authorizableId;
var d=c.formattedName;
if(!d){d=f
}if(f&&f=="anonymous"){if(CQ_collab_comments_requireLogin){$CQ("#"+h).hide();
$CQ("[id$=-reply-button]").hide();
$CQ("[id$=-reply-arrow]").hide()
}else{$CQ("#"+h).show();
$CQ("[id$=-reply-button]").show();
$CQ("[id$=-reply-arrow]").show();
$CQ("#"+b).attr("value","");
$CQ("#"+b+"-comment-block").show();
$CQ("#"+e).attr("value","");
$CQ("#"+e+"-comment-block").show();
$CQ("#"+i).attr("value","");
$CQ("#"+i+"-comment-block").show();
$CQ("[id$=-signed-in-text]").hide();
$CQ("[id$=-signed-in-user]").text("")
}}else{$CQ("[id$=-reply-button]").show();
$CQ("[id$=-reply-arrow]").show();
$CQ("#"+b+"-comment-block").hide();
$CQ("#"+b).attr("value",f);
$CQ("#"+e+"-comment-block").hide();
$CQ("#"+i+"-comment-block").hide();
$CQ("[id$=-signed-in-user]").text(d);
$CQ("[id$=-signed-in-text]").show()
}}}(function(a){window.SCFCards=function(b,c){this.container=a(b);
var e=c||{};
this.cardMargin=e.cardMargin||10;
this.containerPadding=e.containerPadding||0;
this.cardWidth=e.cardWidth||154;
var d=this;
a(window).resize(function(){d.redraw(true)
});
this.redraw(false)
};
SCFCards.prototype.redraw=function(b){this.containerWidth=this.container.outerWidth(true);
this.cards=this.container.find(".scf-card");
this.columns=Math.floor((this.containerWidth-(2*this.containerPadding))/(this.cardWidth+(this.cardMargin*2)));
this.occupiedWidth=Math.ceil(this.columns*(this.cardWidth+(this.cardMargin*2)));
this.newSidePadding=Math.floor((this.containerWidth-this.occupiedWidth)/2);
this.container.css({"padding-left":this.newSidePadding,"padding-right":this.newSidePadding,position:"relative"});
var f=this;
var c=[];
for(var d=0;
d<this.columns;
d++){c[d]=f.newSidePadding
}var e=0;
var g=f.newSidePadding;
this.cards.each(function(o,j){var n=a(j);
var m=f.newSidePadding;
var h=0;
for(var k=0;
k<f.columns;
k++){if(c[k]<=g){g=c[k];
h=k;
if(o<=f.columns&&k>=o){break
}}}m=c[h];
var l=(h)*(f.cardWidth+(f.cardMargin*2))+f.newSidePadding;
if(b){n.animate({position:"absolute",left:l,top:m},500)
}else{n.css({position:"absolute",left:l,top:m})
}c[h]+=n.outerHeight(true);
if(c[h]>e){e=c[h]
}g=c[h]
});
this.container.css({display:"block",height:e+this.newSidePadding})
}
})($CQ);
(function(n,k,j,i,g){window.CQ_Analytics=window.CQ_Analytics||{};
var b=CQ_Analytics;
var l=[];
var f=i.Model.extend({modelName:"CommentSystemModel",relationships:{items:{collection:"CommentList",model:"CommentModel"}},createOperation:"social:createComment",MOVE_OPERATION:"social:moveComment",getCustomProperties:function(o,p){return k.extend(o,p)
},events:{MOVED:"comment:moved",MOVE_ERROR:"comment:moveError",ADD:"comment:added",ADD_ERROR:"comment:adderror"},_fixCachedProperties:function(){if(i.hasOwnProperty("Session")&&(i.Session!==null)){var o=i.Session.checkIfUserCanPost(this.attributes.id);
this.attributes.mayPost=o;
this.fixCachedProperties();
this.cacheFixed=true;
this.trigger("model:cacheFixed",this)
}},fixCachedProperties:function(){},constructor:function(o,p){i.Model.prototype.constructor.apply(this,[o,p]);
if(i.Session.isReady()){this._fixCachedProperties()
}else{i.Session.on("model:loaded",k.bind(this._fixCachedProperties,this))
}},shouldCommentBeAddedToList:function(o){return true
},addCommentSuccess:function(q){var v=q.response;
var p=i.Models[this.constructor.prototype.relationships.items.model];
var t=new p(v);
if(!t.get("isVisible")&&!t.get("draft")){this.view.showUGCLimitDialog(null,true)
}if(this.shouldCommentBeAddedToList(t)){t.set("_isNew",true);
t._isReady=true;
var u=this.get("items");
var s=false;
if(!u){var r=i.Collections[this.constructor.prototype.relationships.items.collection]||j.Collection;
u=new r();
u.model=p;
u.parent=this;
s=true
}u.unshift(t);
var o=this.get("totalSize");
if(s){this.set("items",u)
}this.set("totalSize",o+1);
t.constructor.prototype._cachedModels[v.id]=t;
this.trigger(this.events.ADD,{model:this,newItem:t});
i.Util.announce(this.events.ADD,t.attributes)
}},addComment:function(s,q,v){n(".scf-attachment-error").remove();
var u=k.bind(this.addCommentSuccess,this);
var r=k.bind(function(A,z,x){if(A.status==401){var w=$($(".scf-js-site-title")[0]).attr("href");
window.location.href="http://"+location.host+w.replace(".html","/signin.html")
}else{if(500==A.status){var y=n(".scf-composer-block")[0];
if(null===y){y=n(document.body)
}n('<div class="scf-attachment-error"><h3 class="scf-js-error-message">Server error. Please try again.</h3><div>').appendTo(y);
return false
}this.trigger(this.events.ADD_ERROR,this.parseServerError(A,z,x))
}},this);
var p;
var o=(typeof s.files!=="undefined");
var t=(typeof s.tags!=="undefined");
if(o){if(window.FormData){p=new FormData()
}if(p){n.each(s.files,function(w,x){p.append("file",x)
});
p.append("id","nobot");
p.append(":operation",this.createOperation);
delete s.files;
if(t){n.each(s.tags,function(w,x){p.append("tags",x)
})
}delete s.tags;
n.each(s,function(w,x){p.append(w,x)
})
}}else{p={id:"nobot",":operation":this.createOperation};
k.extend(p,s);
p=this.getCustomProperties(p,s)
}n.ajax(i.config.urlRoot+this.get("id")+i.constants.URL_EXT,{dataType:"json",type:"POST",processData:!o,contentType:(o)?false:"application/x-www-form-urlencoded; charset=UTF-8",xhrFields:{withCredentials:true},data:this.addEncoding(p),success:u,error:r})
},addIncludeHint:function(o){k.extend(o,{"scf:included":this.get("pageInfo").includedPath,"scf:resourceType":this.get("resourceType")})
},move:function(p){var o=k.bind(function(t,s,r){this.trigger(this.events.MOVE_ERROR,{error:r})
},this);
var q=k.bind(this.addCommentSuccess,this);
n.ajax(i.config.urlRoot+this.get("id")+i.constants.URL_EXT,{dataType:"json",type:"POST",xhrFields:{withCredentials:true},data:{":operation":this.MOVE_OPERATION,resourcePath:p.resourcePath,parentPath:p.parentPath},success:q,error:o})
},translateAll:function(u){i.CommentSystem.thisRef=this;
if(this.get("showingTranslationAll")===undefined){this.set("showingTranslationAll",false)
}var p=this.get("items");
var t=[];
t.push(this);
var r;
for(r in p.models){t.push(p.models[r])
}var q=0;
var o=[];
var s=function(){q--;
if(q<=0){i.CommentSystem.thisRef.set("translateAllInProgress",false);
if(i.CommentSystem.thisRef.get("showingTranslationAll")===true){i.CommentSystem.thisRef.set("showingTranslationAll",false)
}else{i.CommentSystem.thisRef.set("showingTranslationAll",true)
}if(i.CommentSystem.thisRef.view){i.CommentSystem.thisRef.view.render()
}}};
if(this.get("showingTranslationAll")===false){for(r in t){if(t[r].get("canTranslate")&&!t[r].get("showingTranslation")){q++;
o.push(t[r])
}}if(q>0){this.set("translateAllInProgress",true);
if(this.view){this.view.render()
}}if(q===0){this.set("showingTranslationAll",true);
if(this.view){this.view.render()
}return
}}else{for(r in t){if(t[r].get("canTranslate")&&t[r].get("showingTranslation")){q++;
o.push(t[r])
}}if(q===0){this.set("showingTranslationAll",false);
if(this.view){this.view.render()
}return
}}for(r in o){o[r].translate(s)
}},refetchUsingSort:function(p,s){var o,r=this.get("pageInfo"),q=this.get("properties"),u=["views","posts","follows","likes"],t=k.intersection(q.sortBy,u);
if(!s){s="DESC"
}p=(p==="newest")?"added":p;
if(t.length>0&&k.contains(t,p)){o=this.get("id")+i.constants.SOCIAL_SELECTOR+"."+p+"_"+q.timeSelector+"."
}else{o=this.get("id")+i.constants.SOCIAL_SELECTOR+"."+p+"."
}o=o+0+".";
if(s=="DESC"){o=o+Math.abs(r.pageSize)
}else{o=o+"-"+Math.abs(r.pageSize)
}o=o+i.constants.JSON_EXT;
this.url=o;
this.reload()
},getSortOrder:function(){var o=[];
o.push({text:CQ.I18n.get("Newest"),value:"newest"});
o.push({text:CQ.I18n.get("Oldest"),value:"added"});
o.push({text:CQ.I18n.get("Last Updated"),value:"latestActivityDate_dt"});
o.push({text:CQ.I18n.get("Most Viewed"),value:"views"});
o.push({text:CQ.I18n.get("Most Active"),value:"posts"});
o.push({text:CQ.I18n.get("Most Followed"),value:"follows"});
o.push({text:CQ.I18n.get("Most Liked"),value:"likes"});
return o
}});
var e=i.View.extend({viewName:"CommentSystem",className:"comment-system",CREATE_EVENT:"SCFCreate",COMMUNITY_FUNCTION:"Comment System",getOtherProperties:function(){return{}
},PAGE_EVENT:"pageComments",PAGE_URL_PREFIX:"comments",init:function(){this.listenTo(this.model,this.model.events.ADD,this.update);
this.listenTo(this.model,this.model.events.ADD_ERROR,this.showErrorOnAdd);
this.listenTo(this.model.get("items"),"comment:deleted",function(o){this.model.set({totalSize:this.model.get("totalSize")-1});
if(i.Util.mayCall(this.model.get("items"),"remove")){this.model.get("items").remove(o.model)
}this.render()
});
this.listenTo(this.model,this.model.events.ADD,this.recordCreate);
this.listenTo(i.Router,"route:"+this.PAGE_EVENT,this.paginate);
i.Router.route(/^(.*?)\.([0-9]*)\.(-?[0-9]*)\.htm.*?$/,this.PAGE_EVENT);
this.model.view=this
},afterRender:function(){window.scrollTo(0,0);
var D=this.model.get("pageInfo"),w=this.model.get("properties"),v=this.model.get("configuration"),y=0,x,t,r,A,o,q,u,s;
if(D&&D.sortIndex){t=x=D.sortIndex;
y=D.pageSize
}else{if(v.sortFields[0]){x=Object.getOwnPropertyNames(v.sortFields[0]).toString();
y=v.pageSize
}else{y=v.pageSize
}}if(!x){x=""
}s=w&&w.sortFieldOrder?w.sortFieldOrder:"desc";
r=typeof(Storage)!=="undefined"&&localStorage.getItem("sortOrderLs")?localStorage.getItem("sortOrderLs"):s;
r=r.toLowerCase();
q=D.orderReversed;
if(!q&&r==="asc"&&x==="added"){q=true
}A=["views","posts","likes","follows"];
o=x.split("_")[0];
if(k.contains(A,o)){this.model.get("pageInfo").sortIndex=o;
x=o
}if(x){switch(true){case (x==="newest"||(t==="added"&&!q)||(x==="added"&&!q)):u=CQ.I18n.get("Newest");
break;
case (x==="latestActivityDate_dt"):u=CQ.I18n.get("Last Updated");
break;
case (x==="added"):u=CQ.I18n.get("Oldest");
break;
case (x==="views"):u=CQ.I18n.get("Most Viewed");
break;
case (x==="posts"):u=CQ.I18n.get("Most Active");
break;
case (x==="follows"):u=CQ.I18n.get("Most Followed");
break;
case (x==="likes"):u=CQ.I18n.get("Most Liked");
break;
default:u=CQ.I18n.get("Sort By")
}this.$el.find(".scf-sort-btngrp-btnlabel").text(u);
if(window.location.href.indexOf("filter=page")>0){var z=window.location.href.split("filter=page+has+")[1];
if(z==null){z=window.location.href.split("filter=page%20has%20")[1]
}var C=null;
var p=null;
if(z.indexOf("/")>0){z=z.substring(0,z.indexOf("/"));
C=($("li[data-component-id$="+z+"]")).find(".scf-comment-data")[0];
p=($(C)).offset().top-50;
var B=$(C).siblings(".scf-load-more");
$("html, body").animate({scrollTop:p},1000,"linear").promise().then(function(){$(B).effect("highlight",{},5000)
})
}else{C=($("li[data-component-id$="+z+"]")).find(".scf-comment-data")[0];
p=($(C)).offset().top-50;
$("html, body").animate({scrollTop:p},1000,"linear").promise().then(function(){$(C).effect("highlight",{},5000)
})
}}}},recordCreate:function(){if(!k.isUndefined(window._satellite)){window._satellite.track("communities-scf-create")
}else{if(b.Sitecatalyst){b.record({event:this.CREATE_EVENT,values:{functionType:i.Context.communityFunction?i.Context.communityFunction:this.COMMUNITY_FUNCTION,path:i.Context.path?i.Context.path:this.model.get("id"),type:i.Context.type?i.Context.type:this.model.get("resourceType"),ugcTitle:i.Context.ugcTitle,siteTitle:i.Context.siteTitle?i.Context.siteTitle:$(".scf-js-site-title").text(),sitePath:i.Context.sitePath?i.Context.sitePath:this.sitePath,groupTitle:i.Context.groupTitle,groupPath:i.Context.groupPath,user:i.Context.user?i.Context.user:i.Session.get("authorizableId")},collect:false,componentPath:i.constants.ANALYTICS_BASE_RESOURCE_TYPE})
}}},paginate:function(){var r=i.config.urlRoot+this.model.get("id")+i.constants.SOCIAL_SELECTOR+".",x=this.model.get("pageInfo"),s=this.model.get("configuration"),t=(x&&!k.isEmpty(x.sortIndex))?x.sortIndex:"",p=s&&s.analyticsTimeSelector?s.analyticsTimeSelector:"total_tl",w=arguments[0],y=arguments[1],u=arguments[2],o=(arguments.length<=3)?null:arguments[3],q=null,v=["views","posts","likes","follows"];
if(k.contains(v,t)){t=t+"_"+p
}if(arguments.length<=3){if(!k.isEmpty(t)){q=r+t+"."+y+"."+u+i.constants.JSON_EXT
}else{q=r+y+"."+u+i.constants.JSON_EXT
}}else{q=r+"index."+y+"."+u+"."+o+i.constants.JSON_EXT
}this.model.url=q+window.location.search;
this.model.reload()
},update:function(){this.files=void 0;
this.render()
},requiresSession:true,showErrorOnAdd:function(p){if(p.details.status.code=="401"){var o=$($(".scf-js-site-title")[0]).attr("href");
window.location.href="http://"+location.host+o.replace(".html","/signin.html")
}else{p.details.status.message=CQ.I18n.get("Comment text is empty");
if(p.details.status.code=="400"){p.details.status.message=CQ.I18n.get("Required fields are missing")
}else{if(this.isExceptionOnUGCLimit(p)){p.details.status.message=CQ.I18n.get("Exceeded contribution limit");
this.showUGCLimitDialog(p.details.error.message)
}else{p.details.status.message=CQ.I18n.get("Server error occurred. Please try again later.")
}}this.addErrorMessage(this.$el.find(".scf-js-composer-block input[type='text'], textarea").first(),p)
}this.log.error(p)
},isExceptionOnUGCLimit:function(p){if(p.details&&p.details.error){var o=p.details.error;
if(o&&o["class"]==="com.adobe.cq.social.scf.OperationException"&&o.message.indexOf("Exceeded contribution limit")>=0){return true
}else{return false
}}return false
},showUGCLimitDialog:function(r,s){if(!n(".scf-comment-ugclimitdialog").length){var q=i.CommentSystemView.templates.ugcLimitDialog;
var p=this.compileTemplate(q);
q=n(p(this.getContextForTemplate()));
n(q).appendTo(this.$el)
}var o=CQ.I18n.get("We are sorry, but as new member you are limited to the number of user generated content that you can create. If you like, you may contact a Community Manager or Community Moderator on the following email(s) : ");
if(s){n(".scf-comment-ugclimitdialog-title").text(CQ.I18n.get("Content Notice"));
n(".scf-comment-ugclimitdialog-text").text(CQ.I18n.get("Your contribution has been submitted. It will appear on the site once approved by a moderator"))
}else{n(".scf-comment-ugclimitdialog-text").text(o+r.split(":")[1])
}n(".scf-comment-ugclimitdialog").modal("show")
},hideError:function(){},expandComposer:function(){this.$el.find(".scf-js-composer-block:first").removeClass("scf-is-collapsed");
var p=this.$el.find(".scf-js-composer-block");
var r=this.getField("message");
var q=CQ.I18n.get("Write a comment");
var o=r.substring(0,q.length);
if(q==o){this.setField("message","")
}if(p.is(":visible")){if(""===r){this.setField("message","")
}}else{this.files=void 0;
this.$el.find(".scf-attachment-list").first().empty()
}this.focus("message")
},cancelComposer:function(){this.$el.find(".scf-js-composer-block:first").addClass("scf-is-collapsed");
this.files=undefined;
n(".scf-js-composer-att").empty();
this.setField("message","");
this.clearErrorMessages()
},toggleComposer:function(o){n(".scf-attachment-error").remove()
},addCommentDraft:function(p){var o=this.extractCommentData(p);
o.isDraft=true;
return this.addToCommentModel(o,p)
},addToCommentModel:function(o,p){this.model.addComment(o);
if(p.target){p.preventDefault()
}return false
},addComment:function(p){var o=this.extractCommentData(p);
if(o===false){return false
}return this.addToCommentModel(o,p)
},extractCommentData:function(r){var p=this.getForm("new-comment");
if(p===null||p.validate()){var s=this.getField("message");
var o=this.getField("tags");
var q=k.extend(this.getOtherProperties(),{message:s,tags:o});
if(!i.Session.get("loggedIn")){q.userIdentifier=this.getField("anon-name");
q.email=this.getField("anon-email");
q.url=this.getField("anon-web")
}if(typeof this.files!=="undefined"){q.files=this.files
}return q
}else{return false
}},navigate:function(x){var z=window.location.protocol+"//"+window.location.host;
var C=$(".scf-page.scf-currentPage",this.$el).data("page-suffix");
if(x!==null){C=n(x.currentTarget).data("page-suffix")
}var D=this.model.get("pageInfo");
var r=i.config.urlRoot;
var u=D.basePageURL;
var p=window.location.search;
if(p.indexOf("filter=page")>0){p=""
}var w=window.location.pathname;
var o=w.substr(w.lastIndexOf(".html")+5);
var B=/(.*)\.(\w*)?\.(\d*)?\.(\d*)?\.html(\/.*)?/;
var t=/(.*)\.(\w*)?\.html(\/.*)?/;
var y=/(.*)\.html(\/.*)?/;
if(k.isUndefined(u)||u===null){var E=w;
var q=B.exec(E);
if(q){E=q[1]+"."+q[2]
}else{q=t.exec(E);
if(q){E=q[1]+"."+q[2]
}else{q=y.exec(E);
E=q[1]
}}u=E
}if((z+g.HTTP.getContextPath()).indexOf(i.config.urlRoot)!=-1){var A=u+"."+C+".html"+o;
A=k.isEmpty(p)?A:A+p;
if(u+".html"==w&&p.indexOf("filter=page")<0){var v=u+"."+D.previousSuffix+".html"+o;
v=k.isEmpty(p)?v:v+p;
i.Router.navigate(v,{trigger:false})
}i.Router.navigate(A,{trigger:true})
}else{C=$(x.currentTarget).data("pageSuffix");
var s=C.split(".");
if(D.sortIndex!==null){this.paginate(u,s[0],s[1],D.sortIndex)
}else{this.paginate(u,s[0],s[1])
}}},renderAttachmentList:function(r){r.preventDefault();
if(typeof this.files=="undefined"){this.files=[]
}this.files.push.apply(this.files,r.target.files);
var o=n(".scf-js-composer-att");
o.empty();
for(var p=0;
p<this.files.length;
p++){var q=this.files[p];
var s=n('<li class="scf-is-attached">'+k.escape(q.name)+" - "+q.size+" bytes</li>");
o.append(s)
}},openAttachmentDialog:function(o){if(i.Util.mayCall(o,"preventDefault")){o.preventDefault()
}this.$el.find("input[type='file']").first().click()
},translateAll:function(){this.model.translateAll()
},toggle:function(o){if(o.currentTarget.getAttribute("aria-expanded")=="false"){o.currentTarget.setAttribute("aria-expanded","true")
}else{o.currentTarget.setAttribute("aria-expanded","false")
}},refetchBasedOnSort:function(r){var q=n(r.target).find(".scf-sort-type").addBack(".scf-sort-type");
var o=q.data("sort-field");
var p=q.data("sort-order");
if(typeof(Storage)!=="undefined"){localStorage.setItem("sortOrderLs",p)
}else{throw new Error("Sorry, your browser does not support Web Storage...")
}this.$el.find(".scf-sort-btngrp-btnlabel").text(q.text());
this.model.refetchUsingSort(o,p)
}});
var d=i.Model.extend({modelName:"CommentModel",DELETE_OPERATION:"social:deleteComment",UPDATE_OPERATION:"social:updateComment",CREATE_OPERATION:"social:createComment",EDIT_TRANSLATION_OPERATION:"social:editTranslation",CHANGESTATE_OPERATION:"social:changeState",events:{ADDED:"comment:added",UPDATED:"comment:updated",DELETED:"comment:deleted",ADD_ERROR:"comment:addError",UPDATE_ERROR:"comment:updateError",DELETE_ERROR:"comment:deleteError",TRANSLATED:"comment:translated",TRANSLATE_ERROR:"comment:translateError"},initialize:function(){if(this.isTranslationPresent()){this.set("showingTranslation",true);
i.Comment.isSmartRenderingOn=true
}this.on("change",function(){if(i.Comment.isSmartRenderingOn===true){if(this.get("showingTranslation")===undefined&&this.isTranslationPresent()){this.set("showingTranslation",true)
}}})
},_fixCachedProperties:function(){if(!this._isReady){this.on("model:loaded",k.bind(this._fixCachedProperties,this));
return
}this.off("model:loaded",k.bind(this._fixCachedProperties,this));
if(i.hasOwnProperty("Session")&&(i.Session!==null)){var p=this.attributes.canEdit;
var o=this.attributes.canDelete;
var y=this.attributes.isFlaggedByUser;
var w=this.attributes.approved;
var v=this.attributes.moderatorActions||{};
var x=i.Session.attributes.loggedIn;
var q=k.isUndefined(i.Session.attributes.id)?"":i.Session.attributes.id.substr(i.Session.attributes.id.lastIndexOf("/")+1);
var u=(this.attributes.author||false)&&i.Session.attributes.loggedIn&&((this.attributes.author.id===i.Session.attributes.id)||((this.attributes.properties||false)&&this.attributes.properties.composedBy===q));
var r=(this.attributes.moderatorStatus||false)&&this.attributes.moderatorStatus.hasOwnProperty("isFlagged")?this.attributes.moderatorStatus.isFlagged:false;
var s=(this.attributes.moderatorStatus||false)&&this.attributes.moderatorStatus.hasOwnProperty("isSpam")?this.attributes.moderatorStatus.isSpam:false;
var t=i.Session.checkIfModeratorFor(this.attributes.sourceComponentId);
v.canAllow=t&&!this.attributes.isClosed&&(s||r||!this.attributes.approved);
v.canDeny=(this.attributes.configuration||false)&&t&&!s&&this.attributes.configuration.isDenyAllowed;
v.canClose=(this.attributes.configuration||false)&&t&&this.attributes.topLevel&&this.attributes.configuration.isCloseAllowed;
v.canFlag=!this.attributes.isClosed&&!y&&x&&w&&!u&&!s&&!r&&this.attributes.configuration.isFlaggingAllowed;
this.attributes.canEdit=t||((this.attributes.configuration||false)&&u&&this.attributes.configuration.isEditAllowed&&!this.attributes.isClosed);
this.attributes.canDelete=t||((this.attributes.configuration||false)&&u&&this.attributes.configuration.isDeleteAllowed&&!this.attributes.isClosed);
this.attributes.canReply=i.Session.attributes.mayReply&&((this.attributes.configuration||false)&&this.attributes.configuration.isReplyAllowed&&!this.attributes.isClosed);
this.attributes.moderatorActions=v;
this.fixCachedProperties(t);
this.cacheFixed=true;
this.trigger("model:cacheFixed",this)
}},fixCachedProperties:function(o){},constructor:function(o,p){i.Model.prototype.constructor.apply(this,[o,p]);
if(i.Session.isReady()){this._fixCachedProperties()
}else{i.Session.on("model:loaded",k.bind(this._fixCachedProperties,this))
}},remove:function(){var o=k.bind(function(s,r,q){this.trigger(this.events.DELETE_ERROR,this.parseServerError(s,r,q))
},this);
var p=k.bind(function(s){var q=1;
var u=1;
if(!(this.attributes.topic||this.attributes.topLevel)){q=this.collection.parent.attributes.totalSize;
u=this.collection.parent.attributes.items.length;
this.collection.parent.set("totalSize",q-1)
}q=q-1;
this.trigger("destroy",this);
if((u==1)&&($('a[class="scf-page scf-currentPage"]').length!==0)){var t=$('a[class="scf-page scf-currentPage"]').data("page-suffix");
var r=t.toString().split(".");
if(r[0]!==0){var v=((parseInt(r[0],10)-parseInt(r[1],10))+"."+r[1]);
window.location.href=window.location.href.replace(t,v)
}}else{if(!this.attributes.topic&&(q%this.attributes.configuration.pageSize==0)){location.reload()
}}this.trigger(this.events.DELETED,{model:this})
},this);
n.ajax(i.config.urlRoot+this.get("id")+i.constants.URL_EXT,{dataType:"json",type:"POST",xhrFields:{withCredentials:true},data:{":operation":this.DELETE_OPERATION},success:p,error:o})
},saveEditTranslation:function(){var p=k.bind(function(t,s,r){this.trigger(this.events.UPDATE_ERROR,this.parseServerError(t,s,r))
},this);
var q=k.bind(function(r){this.reset(r.response,{silent:true});
this.set("showingTranslation",true,{silent:true});
this.set("editTranslationInProgress",false,{silent:true});
if(this.get("translationDisplay")==="side"){this.set("displaySideBySide",true,{silent:true})
}if(this.get("isVisible")){this.trigger(this.events.UPDATED,{model:this})
}else{this.trigger(this.events.DELETED,{model:this});
this.trigger("destroy",this)
}},this);
var o={translatedText:this.get("message"),id:"nobot",":operation":this.EDIT_TRANSLATION_OPERATION};
n.ajax(i.config.urlRoot+this.get("id")+i.constants.TRANSLATE_URL_EXT,{dataType:"json",type:"POST",xhrFields:{withCredentials:true},data:this.addEncoding(o),success:q,error:p})
},saveEdits:function(){var r=k.bind(function(x,w,v){this.trigger(this.events.UPDATE_ERROR,this.parseServerError(x,w,v))
},this);
var u=k.bind(function(w){this.reset(w.response,{silent:true});
if(this.get("isVisible")){this.trigger(this.events.UPDATED,{model:this})
}else{if(this.get("draft")){this.trigger(this.events.UPDATED,{model:this})
}else{if(!this.get("approved")){this.view.showUGCLimitDialog(null,true);
var x=this;
var v=new MutationObserver(function(z){if($(".scf-comment-ugclimitdialog").is(":hidden")){if(x.get("topLevel")){location.href=x.get("pageInfo").basePageURL+".html"
}else{window.location.reload()
}this.disconnect()
}});
var y=document.querySelector(".scf-comment-ugclimitdialog");
v.observe(y,{attributes:true})
}else{this.trigger(this.events.DELETED,{model:this});
this.trigger("destroy",this)
}}}},this);
var p=null;
var s=this.get("files");
var o=(typeof s!=="undefined");
var q=this.get("tags");
var t=l;
if(o){if(window.FormData){p=new FormData()
}if(p){n.each(s,function(v,w){p.append("file",w)
});
p.append("id","nobot");
p.append(":operation",this.UPDATE_OPERATION);
p.append("message",this.get("message"));
n.each(this.getCustomProperties(),function(v,w){p.append(v,w)
});
if(q){n.each(q,function(v,w){p.append("tags",w)
})
}}}if(p===null){p={message:this.get("message"),id:"nobot",":operation":this.UPDATE_OPERATION};
if(q){p.tags=q
}if(t){p.attachmentsTobeDeleted=l
}p=k.extend(this.getCustomProperties(),p)
}n.ajax(i.config.urlRoot+this.get("id")+i.constants.URL_EXT,{dataType:"json",processData:!o,contentType:(o)?false:"application/x-www-form-urlencoded; charset=UTF-8",type:"POST",xhrFields:{withCredentials:true},data:this.addEncoding(p),success:u,error:r})
},loadMore:function(){var o=this.get("pageInfo").nextPageURL;
if(o.indexOf(".html",this.length-5)!==-1){o=o.substr(0,o.lastIndexOf(".html"))+".json"
}else{if(o.indexOf(".null",this.length-5)!==-1){o=o.substr(0,o.lastIndexOf(".null"))+".json"
}}var q=this;
var p=this.constructor.find(o,function(s){var r=s.get("items");
var t=s.get("pageInfo");
q.set("pageInfo",t);
var u=q.get("items");
u.add(r.models,{silent:true,merge:true});
q.trigger(q.events.UPDATED,{model:q})
},true)
},getCustomProperties:function(){return{}
},isTranslationPresent:function(){var o=this.get("translationDescription");
return(!k.isEmpty(o))
},translate:function(q){if(this.get("translationAjaxInProgress")!==true){if(this.isTranslationPresent()){var s=true;
if(this.get("showingTranslation")===true){s=false
}this.set({showingTranslation:s});
this.trigger(this.events.UPDATED,{model:this});
if(q){q()
}return
}this.set("translationAjaxInProgress",true);
var p=k.bind(function(v,u,t){this.set("translationAjaxInProgress",false);
this.trigger(this.events.TRANSLATE_ERROR,this.parseServerError(v,u,t))
},this);
var r=k.bind(function(t){this.set("translationAjaxInProgress",false);
this.set({showingTranslation:true});
this.set({translationDescription:t.translationDescription});
this.set({translationAttribution:t.translationAttribution});
this.set({translationTitle:t.translationTitle});
if(this.get("translationDisplay")==="side"){this.set("displaySideBySide",true,{silent:true})
}this.trigger(this.events.UPDATED,{model:this});
if(q){q()
}},this);
var o=i.config.urlRoot+this.get("id")+i.constants.TRANSLATE_URL_EXT;
n.ajax({type:"GET",url:o,dataType:"json",success:r,error:p});
this.trigger(this.events.UPDATED,{model:this})
}},addReply:function(s,q,u){var t=k.bind(function(y){var B=y.response;
var v=this.constructor.prototype.relationships.items.model;
var x=i.Models[v];
if(k.isUndefined(x)){this.log.error("reply model not found: "+v);
return
}var D=new x(B);
var w;
if(!D.get("isVisible")&&!D.get("draft")){this.view.showUGCLimitDialog(null,true)
}else{var A=window.location.href.indexOf("?filter=page+has+");
if(A!==-1){this.view.navigate()
}if(this.attributes.items.length<this.attributes.configuration.pageSize){D._isReady=true;
D.set("_isNew",true);
var C=this.get("items");
var E=false;
if(!C){var z=i.Collections[this.constructor.prototype.relationships.items.collection]||j.Collection;
C=new z();
C.model=this.constructor;
C.parent=this;
E=true
}C.push(D);
w=this.get("totalSize");
if(E){this.set("items",C)
}this.set("totalSize",w+1);
D.constructor.prototype._cachedModels[B.id]=D
}else{window.location.href=window.location.origin+this.attributes.friendlyUrl+"?filter=page+has+"+B.id.substring(B.id.lastIndexOf("/")+1)
}window.scrollTo(0,0);
$(".scf-social-console-textbox-tooltip").show().delay(5000).hide(0)
}this.trigger(this.events.ADDED,{model:this});
i.Util.announce(this.events.ADDED,D.attributes)
},this);
var r=k.bind(function(x,w,v){this.trigger(this.events.ADD_ERROR,this.parseServerError(x,w,v))
},this);
var p;
var o=(typeof s.files!="undefined");
if(o){if(window.FormData){p=new FormData()
}if(p){n.each(s.files,function(v,w){p.append("file",w)
});
p.append("id","nobot");
p.append(":operation",this.CREATE_OPERATION);
delete s.files;
n.each(s,function(v,w){p.append(v,w)
})
}}else{p={id:"nobot",":operation":this.CREATE_OPERATION};
k.extend(p,s)
}n.ajax(i.config.urlRoot+this.get("id")+i.constants.URL_EXT,{dataType:"json",type:"POST",processData:!o,contentType:(o)?false:"application/x-www-form-urlencoded; charset=UTF-8",xhrFields:{withCredentials:true},data:this.addEncoding(p),success:t,error:r})
},changeCommentState:function(s,q,u){var t=k.bind(function(y){this.set("state",s.toState);
var A=y.response;
var w=this.constructor.prototype.relationships.items.model;
var x=i.Models[w];
if(k.isUndefined(x)){this.log.error("reply model not found: "+w);
return
}var C=new x(A);
C._isReady=true;
C.set("_isNew",true);
var B=this.get("items");
var D=false;
if(!B){var z=i.Collections[this.constructor.prototype.relationships.items.collection]||j.Collection;
B=new z();
B.model=this.constructor;
B.parent=this;
D=true
}B.push(C);
var v=this.get("totalSize");
if(D){this.set("items",B)
}this.set("totalSize",v+1);
C.constructor.prototype._cachedModels[A.id]=C;
this.trigger(this.events.ADDED,{model:this})
},this);
var r=k.bind(function(x,w,v){this.trigger(this.events.ADD_ERROR,this.parseServerError(x,w,v))
},this);
var p=false;
var o={id:"nobot",":operation":this.CHANGESTATE_OPERATION};
k.extend(o,s);
n.ajax(i.config.urlRoot+this.get("id")+i.constants.URL_EXT,{dataType:"json",type:"POST",processData:!p,contentType:(p)?false:"application/x-www-form-urlencoded; charset=UTF-8",xhrFields:{withCredentials:true},data:this.addEncoding(o),success:t,error:r})
},flag:function(q,r){var p=k.bind(function(v,u,t){this.log.error("error flagging comment "+t);
this.trigger("comment:flagerror",{error:t})
},this);
var s=k.bind(function(t){this.reset(t.response,{silent:true});
if(this.get("isVisible")){this.trigger("comment:flagged",{model:this});
this.trigger(this.events.UPDATED,{model:this})
}else{this.trigger(this.events.DELETED,{model:this});
this.trigger("destroy",this)
}},this);
var o={id:"nobot",":operation":"social:flag","social:flagformtext":q,"social:doFlag":r};
n.ajax(i.config.urlRoot+this.get("id")+i.constants.URL_EXT,{dataType:"json",type:"POST",xhrFields:{withCredentials:true},data:this.addEncoding(o),success:s,error:p})
},allow:function(){var p=k.bind(function(t,s,r){this.log.error("error allowing comment "+r);
this.trigger("comment:allowerror",{error:r})
},this);
var q=k.bind(function(r){this.reset(r.response);
this.trigger("comment:allowed",{model:this});
this.trigger(this.events.UPDATED,{model:this})
},this);
var o={id:"nobot",":operation":"social:allow"};
n.ajax(i.config.urlRoot+this.get("id")+i.constants.URL_EXT,{dataType:"json",type:"POST",xhrFields:{withCredentials:true},data:this.addEncoding(o),success:q,error:p})
},resetChildren:function(){var o=this.get("items");
o.each(function(p){p.destroy()
})
},close:function(p){var q=k.bind(function(v,u,t){this.log.error("error closing/opening comment "+t);
this.trigger("comment:closeopenerror",{error:t})
},this);
var s=k.bind(function(t){this.resetChildren();
this.reset(t.response);
this.trigger("comment:closedOpened",{model:this});
this.trigger(this.events.UPDATED,{model:this})
},this);
var r=p?"true":"false";
var o={id:"nobot",":operation":"social:close","social:doClose":r};
n.ajax(i.config.urlRoot+this.get("id")+i.constants.URL_EXT,{dataType:"json",type:"POST",xhrFields:{withCredentials:true},data:this.addEncoding(o),success:s,error:q})
},deny:function(){var p=k.bind(function(t,s,r){this.log.error("error denying comment "+r);
this.trigger("comment:denyerror",{error:r})
},this);
var q=k.bind(function(r){this.reset(r.response);
this.trigger("comment:denied",{model:this});
this.trigger(this.events.UPDATED,{model:this})
},this);
var o={id:"nobot",":operation":"social:deny"};
n.ajax(i.config.urlRoot+this.get("id")+i.constants.URL_EXT,{dataType:"json",type:"POST",xhrFields:{withCredentials:true},data:this.addEncoding(o),success:q,error:p})
},pin:function(){this.doPin(true)
},unpin:function(){this.doPin(false)
},doPin:function(q){var p="comment:pin";
var s="comment:pinerror";
if(!q){p="comment:unpin";
s="comment:unpinerror"
}var r=k.bind(function(w,v,u){this.log.error("error pinunpin comment "+u);
this.trigger(s,{error:u})
},this);
var t=k.bind(function(u){this.reset(u.response);
this.trigger(s,{model:this});
this.trigger(this.events.UPDATED,{model:this})
},this);
var o={":operation":"social:pin","social:doPin":q};
n.ajax(i.config.urlRoot+this.get("id")+i.constants.URL_EXT,{dataType:"json",type:"POST",xhrFields:{withCredentials:true},data:this.addEncoding(o),success:t,error:r})
},markFeatured:function(){this.makeFeatured(true)
},unmarkFeatured:function(){this.makeFeatured(false)
},makeFeatured:function(q){var p="Successfully marked as featured!!";
var s="Failed to mark as featured";
if(!q){p="Successfully unmarked as featured";
s="Failed to unmarked as featured"
}var r=k.bind(function(w,v,u){this.log.error("error toggle topic as featured "+u);
this.trigger(s,{error:u})
},this);
var t=k.bind(function(u){this.reset(u.response);
this.trigger(s,{model:this});
this.trigger(this.events.UPDATED,{model:this})
},this);
var o={":operation":"social:featured","social:markFeatured":q};
n.ajax(i.config.urlRoot+this.get("id")+i.constants.URL_EXT,{dataType:"json",type:"POST",xhrFields:{withCredentials:true},data:this.addEncoding(o),success:t,error:r})
},addIncludeHint:function(q){var o=this;
var p=null;
while(o!==null){if(o.hasOwnProperty("collection")){o=o.collection
}else{p=o.parent.get("resourceType");
o=null
}}k.extend(q,{"scf:included":this.get("pageInfo").includedPath,"scf:resourceType":p})
},deleteAttachment:function(r){var q=k.bind(function(v,u,t){this.log.error("error deleting attachment "+t);
this.trigger("comment:deleteAttError",{error:t})
},this);
var s=k.bind(function(t){var v=this.get("attachments");
var u=k.omit(v,r);
this.set({attachments:u})
},this);
var p=r.substr(r.lastIndexOf("/")+1);
var o={attToRemove:p,":operation":"social:deleteCommentAttachment"};
n.ajax(i.config.urlRoot+this.get("id")+i.constants.URL_EXT,{dataType:"json",type:"POST",xhrFields:{withCredentials:true},data:this.addEncoding(o),success:s,error:q})
},relationships:{items:{collection:"CommentList",model:"CommentModel"},votes:{model:"VotingModel"}}});
var a=i.View.extend({viewName:"Comment",CREATE_EVENT:"SCFCreate",COMMUNITY_FUNCTION:"Comment System",isExceptionOnUGCLimit:e.prototype.isExceptionOnUGCLimit,showUGCLimitDialog:e.prototype.showUGCLimitDialog,init:function(){this.listenTo(this.model,this.model.events.ADDED,this.update);
this.listenTo(this.model,this.model.events.ADD_ERROR,this.showError);
this.listenTo(this.model,this.model.events.UPDATED,this.commentViewUpdate);
this.listenTo(this.model,this.model.events.UPDATE_ERROR,this.showError);
this.listenTo(this.model,this.model.events.DELETED,this.removeView);
this.listenTo(this.model,this.model.events.DELETE_ERROR,this.showError);
this.listenTo(this.model,this.model.events.ADDED,this.recordCreate);
this.model.view=this;
if(this.model.isTranslationPresent()){if(this.model.get("translationDisplay")==="side"){this.model.set("displaySideBySide",true)
}}},loadMore:function(o){o.preventDefault();
this.model.loadMore()
},removeView:function(){j.View.prototype.remove.apply(this,arguments);
if(this.model.get("topLevel")&&this.model.get("topLevel")===true){location.href=this.model.get("pageInfo").basePageURL+".html"
}},commentViewUpdate:function(){this.render()
},update:function(){this.files=undefined;
this.render()
},recordCreate:function(){if(!k.isUndefined(window._satellite)){window._satellite.track("communities-scf-create")
}else{if(b.Sitecatalyst){b.record({event:this.CREATE_EVENT,values:{functionType:i.Context.communityFunction?i.Context.communityFunction:this.COMMUNITY_FUNCTION,path:i.Context.path?i.Context.path:this.model.get("id"),type:i.Context.type?i.Context.type:this.model.get("resourceType"),ugcTitle:i.Context.ugcTitle,siteTitle:i.Context.siteTitle?i.Context.siteTitle:$(".scf-js-site-title").text(),sitePath:i.Context.sitePath?i.Context.sitePath:this.sitePath,groupTitle:i.Context.groupTitle,groupPath:i.Context.groupPath,user:i.Context.user?i.Context.user:i.Session.get("authorizableId")},collect:false,componentPath:i.constants.ANALYTICS_BASE_RESOURCE_TYPE})
}}},afterRender:function(){this.model.unset("_isNew");
var p=$(".generic-translation-all-button");
if(p){if(this.model.get("canTranslate")===true&&!p.show()){p.show()
}}var o=this.$el.find(".scf-js-attachments").not(this.$("[data-scf-component] .scf-js-attachments"));
var q=this;
if(n().imagesLoaded){o.imagesLoaded(function(){q.attachments=new SCFCards(o)
})
}},showError:function(p){var q=this.$el.find(".scf-js-comment-reply-box:first textarea");
this.log.error(p);
if(this.isExceptionOnUGCLimit(p)){this.showUGCLimitDialog(p.details.error.message);
p.details.status.message=CQ.I18n.get("Exceeded contribution limit")
}else{if(p.details.status.code.toString()==="401"){var o=$($(".scf-js-site-title")[0]).attr("href");
window.location.href="http://"+location.host+o.replace(".html","/signin.html")
}else{if(p.details.status.code==="403"){p=p||{};
if(!p.details.status.message){p.details.status.message=CQ.I18n.get("Unknown Error.")
}}else{p.details.status.message=CQ.I18n.get("Server error occurred. Please try again later.")
}}}this.addErrorMessage(q,p)
},hideError:function(){},edittranslation:function(o){this.model.set("editTranslationInProgress",true);
o.stopPropagation();
var q=this.$el.find(".scf-js-comment-edit-box:first");
q.toggle();
this.$el.find(".scf-js-comment-msg:first").toggle();
var p=this.model.get("translationDescription");
this.setField("editMessage",p);
this.focus("editMessage")
},translate:function(){this.model.translate()
},addReply:function(q){var r=this.getField("replyMessage");
var p=true;
var o=k.extend(this.getOtherProperties(p),{message:r});
if(!i.Session.get("loggedIn")){o.userIdentifier=this.getField("anon-name");
o.email=this.getField("anon-email");
o.url=this.getField("anon-web")
}if(typeof this.files!="undefined"){o.files=this.files
}this.clearErrorMessages();
this.model.addReply(o);
q.preventDefault();
return false
},addReplyFromData:function(p,o){if(!i.Session.get("loggedIn")){o.userIdentifier=this.getField("anon-name");
o.email=this.getField("anon-email");
o.url=this.getField("anon-web")
}if(typeof this.files!="undefined"){o.files=this.files
}this.clearErrorMessages();
this.model.addReply(o);
p.preventDefault();
return false
},reply:function(p){p.stopPropagation();
var o=this.$el.find(".scf-js-comment-reply-box:first");
o.toggle();
this.focus("replyMessage");
this.setField("replyMessage","")
},remove:function(o){o.stopPropagation();
var p=this.$el.find(".comment-delete-box:first");
this._closeModal=this.launchModal(p,CQ.I18n.get("Delete"))
},noDelete:function(o){o.stopPropagation();
this._closeModal();
this._closeModal=undefined
},reallyDelete:function(o){o.stopPropagation();
this.model.remove();
this._closeModal();
this._closeModal=undefined
},edit:function(q){q.stopPropagation();
this.model.set("editTranslationInProgress",false);
var s=this.$el.find(".scf-js-comment-edit-box:first");
s.toggle();
this.$el.find(".scf-js-comment-msg:first").toggle();
this.$el.find(".scf-comment-action").hide();
var r=this.model.get("message");
if(!this.model.getConfigValue("isRTEEnabled")){r=n("<div/>").html(r).text()
}var o=this.$el.find(".scf-js-edit-attachments").not(this.$("[data-scf-component] .scf-js-edit-attachments"));
var p=this;
if(n().imagesLoaded){o.imagesLoaded(function(){p.editableAttachments=new SCFCards(o)
})
}if(r.indexOf('<a id="renditionAnchor"')!=-1){r=r.replace(new RegExp("/renditions/","g"),"/images/")
}this.setField("editMessage",r);
this.focus("editMessage")
},save:function(p){var o=this.getData();
this.saveOperation(p,o)
},saveDraft:function(p){var o=this.getData();
o.isDraft=true;
this.saveOperation(p,o)
},publishDraft:function(p){var o=this.getData();
this.saveOperation(p,o)
},changeCommentState:function(p){var q=this.getField("message");
var o=k.extend(this.getOtherProperties(),{message:q});
this.clearErrorMessages();
if(k.isEmpty(q)===false){this.model.changeCommentState(o)
}p.preventDefault();
return false
},saveOperation:function(q,p){q.stopPropagation();
q.preventDefault();
var o=this.model.get("editTranslationInProgress");
this.clearErrorMessages();
this.model.set(p);
if(o){this.model.saveEditTranslation()
}else{this.model.saveEdits()
}l.length=0;
this.files=undefined;
n(".scf-js-composer-att").empty();
return false
},getData:function(){var o=this.getField("editMessage");
var p=this.getField("editTags");
var q=k.extend(this.getOtherProperties(),{message:o,tags:p});
if(typeof this.files!="undefined"){q.files=this.files
}return q
},cancelComposer:function(p){p.stopPropagation();
this.clearErrorMessages();
var o=this.$el.find(".scf-js-comment-reply-box:first");
o.toggle();
this.files=undefined
},cancel:function(r){r.stopPropagation();
this.clearErrorMessages();
var s=this.$el.find(".scf-js-comment-edit-box:first");
s.hide();
var q=this.model.changedAttributes();
if(q){var p=k.keys(q);
var o=k.pick(this.model.previousAttributes(),p);
this.model.set(o)
}this.$el.find(".scf-js-comment-msg:first").show();
this.$el.find(".scf-comment-action").show()
},getOtherProperties:function(){return{}
},editFlagReason:function(p){p.preventDefault();
var o=this.$el.find(".scf-js-flagreason-box:first");
this._closeDialog=this.launchModal(o,CQ.I18n.get("Flag"))
},cancelFlagging:function(o){o.preventDefault();
this._closeDialog();
this._closeDialog=undefined
},addFlagReason:function(p){p.preventDefault();
var o=this.getField("flagReason");
if(o.length===0||o==="custom"){o=this.getField("customFlagReason")
}if(o.length!==0){this.model.flag(o,true)
}else{this.model.flag("",true)
}this._closeDialog();
this._closeDialog=undefined
},toggleFlag:function(p){p.preventDefault();
var o=this.$el.find(".scf-js-toggleFlag-box:first");
o.toggle()
},removeFlag:function(o){o.preventDefault();
this.model.flag(null,false)
},close:function(o){o.preventDefault();
this.model.close(true)
},open:function(o){o.preventDefault();
this.model.close(false)
},allow:function(o){o.preventDefault();
this.model.allow()
},deny:function(o){o.preventDefault();
this.model.deny()
},pin:function(o){o.preventDefault();
this.model.pin()
},unpin:function(o){o.preventDefault();
this.model.unpin()
},markFeatured:function(o){o.preventDefault();
this.model.markFeatured()
},unmarkFeatured:function(o){o.preventDefault();
this.model.unmarkFeatured()
},getLastPath:function(){var o=this.model.get("id");
var p=o.lastIndexOf("/");
p=o.slice(p+1);
return p
},renderAttachmentList:function(r){r.preventDefault();
if(typeof this.files=="undefined"){this.files=[]
}this.files.push.apply(this.files,r.target.files);
var o=n(".scf-js-composer-att");
o.empty();
for(var p=0;
p<this.files.length;
p++){var q=this.files[p];
var s=n('<li class="scf-is-attached">'+k.escape(q.name)+" - "+q.size+" bytes</li>");
o.append(s)
}},openAttachmentDialog:function(o){if(i.Util.mayCall(o,"preventDefault")){o.preventDefault()
}this.$el.find("input[type='file']").first().click()
},toggleAttachmentOverlay:function(p){var o=$(p.target).closest(".scf-js-comment-att");
if(o.hasClass("scf-is-card-overlay-on")){o.removeClass("scf-is-card-overlay-on")
}else{o.addClass("scf-is-card-overlay-on")
}},deleteAttachment:function(r){var p=$(r.target).closest(".scf-js-comment-att");
var o=p.data("attachment-path");
var q=o.substr(o.lastIndexOf("/")+1);
l.push(q);
this.updateEditableAttachments({model:this.model,attachment:o})
},updateEditableAttachments:function(o){var q=o.attachment;
var p=this.$el.find('[data-attachment-path="'+q+'"]');
p.remove();
this.editableAttachments.redraw(true)
},confirmDeleteAttachment:function(p){var o=$(p.target).closest(".scf-js-comment-att");
o.addClass("scf-is-att-confirm-overlay-on")
},cancelDeleteAttachment:function(p){var o=$(p.target).closest(".scf-js-comment-att");
o.removeClass("scf-is-att-confirm-overlay-on")
}});
var m=j.Collection.extend({collectionName:"CommentList"});
var h=i.Model.extend({modelName:"AuthorModel"});
var c=i.View.extend({viewName:"Author",tagName:"div",className:"author"});
i.Comment=d;
i.CommentSystem=f;
i.CommentView=a;
i.CommentSystemView=e;
i.CommentList=m;
i.Author=h;
i.AuthorView=c;
i.registerComponent("social/commons/components/hbs/comments/comment",i.Comment,i.CommentView);
i.registerComponent("social/commons/components/hbs/comments",i.CommentSystem,i.CommentSystemView)
})($CQ,_,Backbone,SCF,Granite);
(function(c,a,d,b){b.CommentSystemView.templates=b.CommentSystemView.templates||{};
b.CommentSystemView.templates.ugcLimitDialog='<div class="modal fade scf-comment-ugclimitdialog" tabindex="-1" role="dialog"><div class="modal-dialog" role="document"><div class="modal-content"><div class="modal-header"><button type="button" onclick="$CQ(\'.scf-comment-ugclimitdialog\').hide();$CQ(\'body\').removeClass(\'modal-open\');$CQ(\'.modal-backdrop.fade.in\').remove();" class="close scf-modal-close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button><h2 class="modal-title scf-comment-ugclimitdialog-title">{{i18n "Content Notice"}}</h2></div><div class="modal-body"><div class="clearfix"></div><p class="text-center scf-comment-ugclimitdialog-text"></p></div><div class="modal-footer"><button type="button" onclick="$CQ(\'.scf-comment-ugclimitdialog\').hide();$CQ(\'body\').removeClass(\'modal-open\');$CQ(\'.modal-backdrop.fade.in\').remove();" class="btn btn-primary" data-dismiss="modal">{{i18n "Close"}}</button></div></div><!-- /.modal-content --></div><!-- /.modal-dialog --></div><!-- /.modal -->'
})($CQ,_,Backbone,SCF);
/*!
 * imagesLoaded PACKAGED v4.1.1
 * JavaScript is all like "You images are done yet or what?"
 * MIT License
 */
(function(b,a){if(typeof define=="function"&&define.amd){define("ev-emitter/ev-emitter",a)
}else{if(typeof module=="object"&&module.exports){module.exports=a()
}else{b.EvEmitter=a()
}}}(typeof window!="undefined"?window:this,function(){function a(){}var b=a.prototype;
b.on=function(c,f){if(!c||!f){return
}var d=this._events=this._events||{};
var e=d[c]=d[c]||[];
if(e.indexOf(f)==-1){e.push(f)
}return this
};
b.once=function(d,e){if(!d||!e){return
}this.on(d,e);
var c=this._onceEvents=this._onceEvents||{};
var f=c[d]=c[d]||{};
f[e]=true;
return this
};
b.off=function(c,f){var e=this._events&&this._events[c];
if(!e||!e.length){return
}var d=e.indexOf(f);
if(d!=-1){e.splice(d,1)
}return this
};
b.emitEvent=function(c,d){var f=this._events&&this._events[c];
if(!f||!f.length){return
}var e=0;
var h=f[e];
d=d||[];
var j=this._onceEvents&&this._onceEvents[c];
while(h){var g=j&&j[h];
if(g){this.off(c,h);
delete j[h]
}h.apply(this,d);
e+=g?0:1;
h=f[e]
}return this
};
return a
}));
/*!
 * imagesLoaded v4.1.1
 * JavaScript is all like "You images are done yet or what?"
 * MIT License
 */
(function(b,a){if(typeof define=="function"&&define.amd){define(["ev-emitter/ev-emitter"],function(c){return a(b,c)
})
}else{if(typeof module=="object"&&module.exports){module.exports=a(b,require("ev-emitter"))
}else{b.imagesLoaded=a(b,b.EvEmitter)
}}})(window,function factory(g,c){var e=g.jQuery;
var d=g.console;
function h(l,k){for(var m in k){l[m]=k[m]
}return l
}function a(m){var l=[];
if(Array.isArray(m)){l=m
}else{if(typeof m.length=="number"){for(var k=0;
k<m.length;
k++){l.push(m[k])
}}else{l.push(m)
}}return l
}function f(m,l,k){if(!(this instanceof f)){return new f(m,l,k)
}if(typeof m=="string"){m=document.querySelectorAll(m)
}this.elements=a(m);
this.options=h({},this.options);
if(typeof l=="function"){k=l
}else{h(this.options,l)
}if(k){this.on("always",k)
}this.getImages();
if(e){this.jqDeferred=new e.Deferred()
}setTimeout(function(){this.check()
}.bind(this))
}f.prototype=Object.create(c.prototype);
f.prototype.options={};
f.prototype.getImages=function(){this.images=[];
this.elements.forEach(this.addElementImages,this)
};
f.prototype.addElementImages=function(o){if(o.nodeName=="IMG"){this.addImage(o)
}if(this.options.background===true){this.addElementBackgroundImages(o)
}var k=o.nodeType;
if(!k||!b[k]){return
}var p=o.querySelectorAll("img");
for(var n=0;
n<p.length;
n++){var l=p[n];
this.addImage(l)
}if(typeof this.options.background=="string"){var m=o.querySelectorAll(this.options.background);
for(n=0;
n<m.length;
n++){var q=m[n];
this.addElementBackgroundImages(q)
}}};
var b={1:true,9:true,11:true};
f.prototype.addElementBackgroundImages=function(m){var l=getComputedStyle(m);
if(!l){return
}var o=/url\((['"])?(.*?)\1\)/gi;
var n=o.exec(l.backgroundImage);
while(n!==null){var k=n&&n[2];
if(k){this.addBackground(k,m)
}n=o.exec(l.backgroundImage)
}};
f.prototype.addImage=function(k){var l=new i(k);
this.images.push(l)
};
f.prototype.addBackground=function(k,m){var l=new j(k,m);
this.images.push(l)
};
f.prototype.check=function(){var l=this;
this.progressedCount=0;
this.hasAnyBroken=false;
if(!this.images.length){this.complete();
return
}function k(o,n,m){setTimeout(function(){l.progress(o,n,m)
})
}this.images.forEach(function(m){m.once("progress",k);
m.check()
})
};
f.prototype.progress=function(m,l,k){this.progressedCount++;
this.hasAnyBroken=this.hasAnyBroken||!m.isLoaded;
this.emitEvent("progress",[this,m,l]);
if(this.jqDeferred&&this.jqDeferred.notify){this.jqDeferred.notify(this,m)
}if(this.progressedCount==this.images.length){this.complete()
}if(this.options.debug&&d){d.log("progress: "+k,m,l)
}};
f.prototype.complete=function(){var l=this.hasAnyBroken?"fail":"done";
this.isComplete=true;
this.emitEvent(l,[this]);
this.emitEvent("always",[this]);
if(this.jqDeferred){var k=this.hasAnyBroken?"reject":"resolve";
this.jqDeferred[k](this)
}};
function i(k){this.img=k
}i.prototype=Object.create(c.prototype);
i.prototype.check=function(){var k=this.getIsImageComplete();
if(k){this.confirm(this.img.naturalWidth!==0,"naturalWidth");
return
}this.proxyImage=new Image();
this.proxyImage.addEventListener("load",this);
this.proxyImage.addEventListener("error",this);
this.img.addEventListener("load",this);
this.img.addEventListener("error",this);
this.proxyImage.src=this.img.src
};
i.prototype.getIsImageComplete=function(){return this.img.complete&&this.img.naturalWidth!==undefined
};
i.prototype.confirm=function(k,l){this.isLoaded=k;
this.emitEvent("progress",[this,this.img,l])
};
i.prototype.handleEvent=function(k){var l="on"+k.type;
if(this[l]){this[l](k)
}};
i.prototype.onload=function(){this.confirm(true,"onload");
this.unbindEvents()
};
i.prototype.onerror=function(){this.confirm(false,"onerror");
this.unbindEvents()
};
i.prototype.unbindEvents=function(){this.proxyImage.removeEventListener("load",this);
this.proxyImage.removeEventListener("error",this);
this.img.removeEventListener("load",this);
this.img.removeEventListener("error",this)
};
function j(k,l){this.url=k;
this.element=l;
this.img=new Image()
}j.prototype=Object.create(i.prototype);
j.prototype.check=function(){this.img.addEventListener("load",this);
this.img.addEventListener("error",this);
this.img.src=this.url;
var k=this.getIsImageComplete();
if(k){this.confirm(this.img.naturalWidth!==0,"naturalWidth");
this.unbindEvents()
}};
j.prototype.unbindEvents=function(){this.img.removeEventListener("load",this);
this.img.removeEventListener("error",this)
};
j.prototype.confirm=function(k,l){this.isLoaded=k;
this.emitEvent("progress",[this,this.element,l])
};
f.makeJQueryPlugin=function(k){k=k||g.jQuery;
if(!k){return
}e=k;
e.fn.imagesLoaded=function(m,n){var l=new f(this,m,n);
return l.jqDeferred.promise(e(this))
}
};
f.makeJQueryPlugin();
return f
});